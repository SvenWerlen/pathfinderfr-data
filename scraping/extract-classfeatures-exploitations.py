#!/usr/bin/python3
# -*- coding: utf-8 -*-

import urllib.request
import yaml
import sys
import html
import re
from bs4 import BeautifulSoup
from lxml import html

from libhtml import jumpTo, html2text, cleanSectionName, mergeYAML

## Configurations pour le lancement
MOCK_EXPLOITATION = None
#MOCK_EXPLOITATION = "mocks/exploitations.html"       # décommenter pour tester avec les astuces pré-téléchargées

URL = "https://www.pathfinder-fr.org/Wiki/Pathfinder-RPG.Exploitations.ashx"
FIELDS = ['Nom', 'Classe', 'Archétype', 'Prérequis', 'Source', 'Niveau', 'Auto', 'Description', 'DescriptionHTML', 'Référence' ]
MATCH = ['Nom', 'Classe', 'Archétype']

liste = []

print("Extraction des aptitude (exploitations)...")


source = 'MCA'

if MOCK_EXPLOITATION:
    content = BeautifulSoup(open(MOCK_EXPLOITATION),features="lxml").body
else:
    content = BeautifulSoup(urllib.request.urlopen(URL).read(),features="lxml").body

section = jumpTo(content, 'h2',{'class':'separator'}, u"Exploitations d'arcaniste")

level = 0
for s in section:
 
    if s.name == 'div' and s.has_attr('class') and "article_2col" in s['class']:
        level = 2 if level == 0 else 11

        exploitation = {'Source':source,'Niveau':level}
        newObj = False
        brCount = 0
        descr = ""
        descrHTML = ""
        for e in s.children:
            if e.name == 'h3':
                if newObj:
                    exploitation['Classe'] = 'Arcaniste'
                    exploitation['Description'] = descr.strip()
                    exploitation['DescriptionHTML'] = descrHTML
                    liste.append(exploitation)
                    exploitation = {'Source':'MJ','Niveau':level}
                    brCount = 0
                    descr = ""
                    descrHTML = ""
                exploitation['Nom'] = "Exploitation: " + cleanSectionName(e.text)
                exploitation['Référence'] = URL + e.find_next("a")['href']
                newObj = True
            elif e.name == 'br':
                brCount+=1
                if(brCount==2 and u'Prérequis' in exploitation):
                    descr = ""
                    descrHTML = ""
                    
            elif e.name == 'div' and not e.has_attr('class'):
                exit(1)
            
            else:
                descr += html2text(e, False)
                descrHTML += html2text(e, False, 2)
            
        
        ## last element
        exploitation['Classe'] = 'Arcaniste'
        exploitation['Description'] = descr.strip()
        exploitation['DescriptionHTML'] = descrHTML
        liste.append(exploitation)
            
            
print("Fusion avec fichier YAML existant...")

HEADER = ""

mergeYAML("../data/classfeatures.yml", MATCH, FIELDS, HEADER, liste)
